{% extends "base.html" %}
{% block content %}
<div class="header">
  <div>
    <h1 class="title">Run Detail</h1>
    <p class="subtitle mono">{{ run.run_id }}</p>
  </div>
  <div><span class="pill {{ run.status }}">{{ run.status }}</span></div>
</div>

<section class="cards">
  <article class="card"><div class="k">Created</div><div class="v" style="font-size: 16px;">{{ run.created_at[:19] | replace("T", " ") }}</div></article>
  <article class="card"><div class="k">Started</div><div class="v" style="font-size: 16px;">{% if run.started_at %}{{ run.started_at[:19] | replace("T", " ") }}{% else %}-{% endif %}</div></article>
  <article class="card"><div class="k">Completed</div><div class="v" style="font-size: 16px;">{% if run.completed_at %}{{ run.completed_at[:19] | replace("T", " ") }}{% else %}-{% endif %}</div></article>
  <article class="card"><div class="k">Back</div><div class="v" style="font-size: 16px;"><a class="link" href="/runs">All runs</a></div></article>
</section>

<section class="card table-card">
  <div class="k">Prompt</div>
  <pre class="output">{{ run.prompt or "" }}</pre>
</section>

<section class="card table-card">
  <div class="k">Output</div>
  <pre class="output">{{ run.output or "" }}</pre>
</section>

{% if run.error %}
<section class="card table-card">
  <div class="k">Error</div>
  {% if run.error_code %}
  <div class="error-banner">
    <div class="error-code">{{ run.error_code }}</div>
    <div class="error-title">{{ run.error_title }}</div>
    <div class="error-message">{{ run.error_message }}</div>
  </div>
  {% endif %}
  <pre class="output">{{ run.error }}</pre>
</section>
{% endif %}

{% if recovery_options %}
<section class="card table-card">
  <div class="k">Recovery Actions</div>
  <div class="recovery-list">
    {% for option in recovery_options %}
    <div class="recovery-item">
      <div class="recovery-meta">
        <div class="recovery-label">{{ option.label }}</div>
        <div class="dim">{{ option.description }}</div>
      </div>
      {% if option.kind == "api" %}
      <button class="btn recovery-btn" data-action="{{ option.action_id }}">Run</button>
      {% else %}
      <a class="btn" href="{{ option.href }}">Open</a>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  <div id="recoveryStatus" class="dim" role="status" aria-live="polite"></div>
</section>
{% endif %}

<section class="card table-card">
  <div class="k">Live Timeline</div>
  <div class="toolbar">
    <label class="dim">Type
      <select id="eventType">
        <option value="">All</option>
        <option value="run.started">run.started</option>
        <option value="run.provider.selected">run.provider.selected</option>
        <option value="run.provider.used">run.provider.used</option>
        <option value="run.policy.applied">run.policy.applied</option>
        <option value="run.completed">run.completed</option>
        <option value="run.failed">run.failed</option>
        <option value="security.redaction.applied">security.redaction.applied</option>
        <option value="recovery.attempted">recovery.attempted</option>
        <option value="recovery.queued">recovery.queued</option>
        <option value="recovery.completed">recovery.completed</option>
        <option value="recovery.failed">recovery.failed</option>
      </select>
    </label>
    <label class="dim">Search
      <input id="searchText" type="text" placeholder="Filter payload..." />
    </label>
    <label class="dim">
      <input id="pauseLive" type="checkbox" />
      Pause live updates
    </label>
    <label class="dim">
      <input id="autoScroll" type="checkbox" checked />
      Autoscroll
    </label>
    <a class="btn" href="/api/runs/{{ run.run_id }}/artifact.txt">Download artifact</a>
  </div>
  <ul class="timeline" id="timeline" aria-live="polite" aria-label="Run event timeline">
    {% if events %}
    {% for e in events %}
    <li>
      <div><span class="pill">{{ e.event_type }}</span></div>
      <div class="dim">{{ e.created_at[:19] | replace("T", " ") }}</div>
      <div>{{ e.payload }}</div>
    </li>
    {% endfor %}
    {% else %}
    <li><div class="dim">No events yet.</div></li>
    {% endif %}
  </ul>
</section>

<script>
  (function () {
    const runId = "{{ run.run_id }}";
    let rawEvents = [];
    const timelineEl = document.getElementById("timeline");
    const typeEl = document.getElementById("eventType");
    const searchEl = document.getElementById("searchText");
    const pauseEl = document.getElementById("pauseLive");
    const autoScrollEl = document.getElementById("autoScroll");
    const recoveryStatusEl = document.getElementById("recoveryStatus");

    function esc(s) {
      return String(s || "").replace(/[&<>"']/g, function (m) {
        if (m === "&") return "&amp;";
        if (m === "<") return "&lt;";
        if (m === ">") return "&gt;";
        if (m === '"') return "&quot;";
        return "&#39;";
      });
    }
    async function runRecoveryAction(actionId) {
      if (!actionId) return;
      if (recoveryStatusEl) recoveryStatusEl.textContent = "Submitting recovery action...";
      const res = await fetch("/api/runs/" + runId + "/recover", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ action_id: actionId }),
      });
      if (!res.ok) {
        if (recoveryStatusEl) recoveryStatusEl.textContent = "Recovery failed to submit.";
        return;
      }
      const data = await res.json();
      if (data.redirect_to) {
        if (recoveryStatusEl) recoveryStatusEl.textContent = "Recovery action completed. Opening target...";
        window.location.href = data.redirect_to;
        return;
      }
      if (recoveryStatusEl) {
        recoveryStatusEl.textContent = "Recovery queued: action=" + data.action_id + ", status=" + data.status + (data.job_id ? ", job=" + data.job_id : "");
      }
      await refreshEvents();
    }
    function renderTimeline() {
      const typeFilter = typeEl.value;
      const searchFilter = (searchEl.value || "").toLowerCase().trim();
      const filtered = rawEvents.filter(function (e) {
        if (typeFilter && e.event_type !== typeFilter) return false;
        if (!searchFilter) return true;
        return String(e.payload || "").toLowerCase().indexOf(searchFilter) >= 0;
      });
      const items = filtered.map(function (e) {
        return "<li>" +
          "<div><span class='pill'>" + esc(e.event_type) + "</span></div>" +
          "<div class='dim'>" + esc((e.created_at || "").replace("T", " ").slice(0, 19)) + "</div>" +
          "<div>" + esc(e.payload || "") + "</div>" +
          "</li>";
      }).join("");
      timelineEl.innerHTML = items || "<li><div class='dim'>No matching events.</div></li>";
      if (autoScrollEl.checked) {
        window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
      }
    }
    async function refreshEvents() {
      if (pauseEl.checked) return;
      const res = await fetch("/api/runs/" + runId + "/events?limit=200");
      if (!res.ok) return;
      rawEvents = await res.json();
      renderTimeline();
    }
    typeEl.addEventListener("change", renderTimeline);
    searchEl.addEventListener("input", renderTimeline);
    document.querySelectorAll(".recovery-btn").forEach(function (el) {
      el.addEventListener("click", function () {
        runRecoveryAction(el.getAttribute("data-action"));
      });
    });
    rawEvents = [
      {% for e in events %}
      {"event_type": "{{ e.event_type }}", "created_at": "{{ e.created_at }}", "payload": {{ e.payload | tojson }}},
      {% endfor %}
    ];
    renderTimeline();
    setInterval(refreshEvents, 2000);
  })();
</script>
{% endblock %}
