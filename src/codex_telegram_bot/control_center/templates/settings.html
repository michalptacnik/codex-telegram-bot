{% extends "base.html" %}
{% block content %}
<div class="header">
  <div>
    <h1 class="title">Settings</h1>
    <p class="subtitle">Runtime diagnostics and provider baseline</p>
  </div>
</div>

{% if execution_profile_warning %}
<section class="error-banner" style="margin-top: 12px;">
  <div class="k">Security Warning</div>
  <div>{{ execution_profile_warning }}</div>
</section>
{% endif %}
{% if error %}
<section class="error-banner" style="margin-top: 12px;">
  <div class="k">Error</div>
  <div>{{ error }}</div>
</section>
{% endif %}

<section class="cards">
  <article class="card">
    <div class="k">Provider Version</div>
    <div class="v" style="font-size: 20px;">{{ provider_version }}</div>
  </article>
  <article class="card">
    <div class="k">Execution Profile</div>
    <div class="v" style="font-size: 20px;">{{ execution_profile.profile }}</div>
  </article>
  <article class="card">
    <div class="k">State Storage</div>
    <div class="v" style="font-size: 20px;">SQLite</div>
  </article>
  <article class="card">
    <div class="k">Next</div>
    <div class="v" style="font-size: 20px;">Policies + Auth</div>
  </article>
</section>

<section class="card table-card">
  <div class="k">Execution Profile Controls</div>
  <p class="dim">SAFE is default. UNSAFE requires unlock countdown + phrase confirmation and auto-expires in 24h.</p>
  <form method="POST" action="/settings/execution-profile" class="toolbar">
    <label for="profile">Profile</label>
    <select id="profile" name="profile">
      <option value="safe" {% if execution_profile.profile == 'safe' %}selected{% endif %}>SAFE</option>
      <option value="power_user" {% if execution_profile.profile == 'power_user' %}selected{% endif %}>POWER_USER</option>
      <option value="unsafe" {% if execution_profile.profile == 'unsafe' %}selected{% endif %}>UNSAFE (start unlock)</option>
    </select>
    <label for="profile-user-id">Admin user ID</label>
    <input id="profile-user-id" name="user_id" value="{{ execution_profile.enabled_by_user_id or '0' }}" />
    <button class="btn" type="submit">Apply</button>
  </form>
  <form method="POST" action="/settings/execution-profile/confirm-unsafe" class="toolbar">
    <label for="unsafe-code">Unlock code</label>
    <input id="unsafe-code" name="code" placeholder="6-digit code" />
    <label for="unsafe-user-id">Admin user ID</label>
    <input id="unsafe-user-id" name="user_id" value="{{ execution_profile.enabled_by_user_id or '0' }}" />
    <input type="hidden" name="phrase" value="{{ unsafe_unlock_phrase }}" />
    <button class="btn" type="submit">Confirm UNSAFE</button>
  </form>
  <div class="dim mono">
    phrase: {{ unsafe_unlock_phrase }}<br />
    unsafe_expires_at: {{ execution_profile.unsafe_expires_at or '-' }}
  </div>
</section>

<section class="card table-card">
  <div class="k">Provider Health</div>
  <pre class="output">{{ provider_health | tojson(indent=2) }}</pre>
</section>

<section class="card table-card">
  <div class="k">Execution Profile Audit</div>
  <table>
    <thead>
      <tr>
        <th>When</th>
        <th>Origin</th>
        <th>User</th>
        <th>From → To</th>
        <th>Reason</th>
      </tr>
    </thead>
    <tbody>
      {% for row in execution_profile_audit %}
      <tr>
        <td class="mono">{{ row.created_at }}</td>
        <td>{{ row.origin }}</td>
        <td class="mono">{{ row.changed_by_user_id }}</td>
        <td class="mono">{{ row.from_profile }} → {{ row.to_profile }}</td>
        <td>{{ row.reason }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<section class="card table-card">
  <div class="k">WhatsApp Linking</div>
  {% if whatsapp_enabled %}
  <p class="dim">Generate a one-time code, then send <code>/link &lt;code&gt;</code> from WhatsApp.</p>
  <form id="whatsapp-link-form" class="toolbar">
    <label for="wa-chat-id">Chat ID</label>
    <input id="wa-chat-id" name="chat_id" value="1" />
    <label for="wa-user-id">User ID</label>
    <input id="wa-user-id" name="user_id" value="1" />
    <label for="wa-ttl">TTL sec</label>
    <input id="wa-ttl" name="ttl_sec" value="900" />
    <button class="btn" type="submit">Generate Code</button>
  </form>
  <pre id="wa-link-output" class="output">(none)</pre>
  <script>
    (function () {
      const form = document.getElementById("whatsapp-link-form");
      const out = document.getElementById("wa-link-output");
      if (!form || !out) return;
      form.addEventListener("submit", async function (ev) {
        ev.preventDefault();
        out.textContent = "Generating...";
        try {
          const payload = {
            chat_id: Number(document.getElementById("wa-chat-id").value || "0"),
            user_id: Number(document.getElementById("wa-user-id").value || "0"),
            ttl_sec: Number(document.getElementById("wa-ttl").value || "900"),
          };
          const res = await fetch("/api/whatsapp/link-code", {
            method: "POST",
            headers: {"content-type": "application/json"},
            body: JSON.stringify(payload),
          });
          const body = await res.json();
          if (!res.ok) {
            out.textContent = body.detail || JSON.stringify(body);
            return;
          }
          out.textContent = `code=${body.code}\nexpires_at=${body.expires_at}\nchat_id=${body.chat_id}\nuser_id=${body.user_id}`;
        } catch (err) {
          out.textContent = String(err || "unknown error");
        }
      });
    })();
  </script>
  {% else %}
  <p class="dim">WhatsApp bridge is disabled. Set <code>WHATSAPP_ENABLED=1</code> and restart Control Center.</p>
  {% endif %}
</section>
{% endblock %}
